FROM ankur1825/horizon-jenkins:1.0.6
USER root
SHELL ["/bin/bash","-o","pipefail","-c"]

ARG TF_VERSION=1.7.7
ENV TF_IN_AUTOMATION=1

RUN set -eux; \
  arch="$(dpkg --print-architecture)"; \
  case "$arch" in amd64) tf_arch=linux_amd64 ;; arm64) tf_arch=linux_arm64 ;; *) echo "Unsupported arch: $arch" >&2; exit 1 ;; esac; \
  url="https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_${tf_arch}.zip"; \
  if curl -sfI "$url" >/dev/null; then \
    echo "Installing Terraform from zip ${TF_VERSION}…"; \
    curl -fsSLo /tmp/terraform.zip "$url"; \
    unzip -o /tmp/terraform.zip -d /usr/local/bin; \
    chmod +x /usr/local/bin/terraform; \
    rm -f /tmp/terraform.zip; \
  else \
    echo "Zip ${TF_VERSION} not found. Falling back to HashiCorp APT repo…"; \
    apt-get update; \
    apt-get install -y --no-install-recommends curl gnupg lsb-release ca-certificates; \
    install -m 0755 -d /etc/apt/keyrings; \
    curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /etc/apt/keyrings/hashicorp-archive-keyring.gpg; \
    echo "deb [signed-by=/etc/apt/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(. /etc/os-release && echo $VERSION_CODENAME) main" \
      > /etc/apt/sources.list.d/hashicorp.list; \
    apt-get update; \
    (apt-get install -y terraform=${TF_VERSION}* || apt-get install -y terraform); \
  fi; \
  terraform -version

USER jenkins
